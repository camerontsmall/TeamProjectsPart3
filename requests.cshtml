@using Models
@{
    Layout = "~/_Layout.cshtml";
    Page.Title = "Manage Requests";
    Page.Path = "requests";
    var DB = Database.Open("dbConnectionString");


    string title = "";

    if (IsPost) {
        string module = Request.Form["modulecode"];
        string day = Request.Form["day"];
        string period = Request.Form["period"];
        string week = Request.Form["weeks"];
        string semester = Request.Form["semester"];

        string roomtype = Request.Form["roomtype"];
        string roompark = Request.Form["roompark"];
        string roompref = Request.Form["roompref"];
        string capacity = Request.Form["capacity"];
        string special = Request.Form["special"];
        string facility = Request.Form["facility"];

        string insert_statement = "INSERT INTO request (module_code, day, period, week, owner, semester, status, last_changed, booking_round) VALUES (@0, @1, @2, @3, @4, @5, 'p', @6, 0)";
        string room_statement = "INSERT INTO request_room (request_id, room_code, park, capacity, type, special, facility) VALUES (@@IDENTITY ,@0, @1,@2, @3, @4, @5)";

        if (module.Length > 0 && period.Length > 0) {
            try {
                DB.Execute(insert_statement, module, day, period, week, WebSecurity.CurrentUserId, semester, System.DateTime.Now);
                DB.Execute(room_statement, roompref, roompark, capacity, roomtype, special, facility);

            <div class="card-panel green white-text">
               Succesfully added request for @module
            </div>
            } catch (Exception e) {
            <div class="card-panel red white-text">
                Add request failed: @e.ToString()
            </div>
            }
        } else {
            <div class="card-panel orange">
                Please pick a module and time slot
            </div>

        }

    }

    if (Request.QueryString["message"] == "deleted")
    {
        <div class="card-panel green white-text">
            Deleted request @Request.QueryString["id"]
        </div>
    }else if (Request.QueryString["message"] == "withdrawn") {
        <div class="card-panel green white-text">
            Withdrew request @Request.QueryString["id"]
        </div>
    }

    var Data = DB.Query("SELECT * FROM request ORDER BY last_changed DESC");

    var ldata = Models.Request.convertTo(Data);

    var tediousList = new List<Dictionary<string, string>>();
    foreach (Request r in ldata) {
        tediousList.Add(r.ToNiceList());
    }

    var JSON = Json.Encode(tediousList);

    string newmodule_code = "";
    int newday = 1;
    string newperiods = "";
    string newweek = "";
    int newcapacity = 50;
    string newtype = "";
    string newpark = "";
    string newroom = "";

    if (Request.QueryString["copy"] != null) {
        string past_id = Request.QueryString["copy"].ToString();
        var past = DB.QuerySingle("SELECT * FROM pastsubmissions WHERE RequestNo = @0", past_id);
        newmodule_code = past["ModuleCode"];
        newday = past["Day"];
        newperiods = past["Period"].ToString();
        int startperiod = past["Period"];
        for (int i = 1; i < past["Length"]; i++) {
            newperiods += ("," + (startperiod + i));
        }
        <div class="card-panel blue">
            Copying previous request @past_id
        </div>
    }
}

<h4>Add request</h4>
<div id="requestForm">
    <form method="post" action="./requests.cshtml">
        <div class="row">
            <div class="col s12 m12 l6" id="form_left">
                <label for="partinput">Degree Part</label>
                <select id="partinput" class="browser-default" name="part" value="@newmodule_code" onchange="loadModules('@Department.User.departmentID()')">
                    @RequestForm.Parts()
                </select>
                <br />
                <label for="moduleinput">Module Code</label>
                <select id="moduleinput" class="browser-default" name="modulecode" value="@newmodule_code">
                    @RequestForm.Modules(Department.User.departmentID(), newmodule_code)
                </select>
                <br />
                <label for="dayinput">Day</label>
                <select id="dayinput" class="browser-default" name="day" value="@newday">
                    @RequestForm.Days(newday)
                </select>
                <br />
                <label for="periodinput">Period(s)</label>
                <select multiple id="periodinput" class="browser-default" name="period">
                    <!-- @newperiods -->
                    @RequestForm.Periods(newperiods)
                </select>
                <br />
                <label for="weeksinnput" class="active">Week(s)</label>
                <select multiple id="weeksinput" class="browser-default" name="weeks">
                    @RequestForm.Weeks()
                </select>
            </div>
            <div class="col s12 m12 l6" id="form_right">
                <label for="capacityinput">Capacity required</label>
                <input id="capacityinput" type="number" name="capacity" value="@newcapacity" min="0" max="400"/>
                <br />
                <label for="roomtypeinput">Preferred room type</label>
                <select id="roomtypeinput" class="browser-default" name="roomtype" >
                    @RequestForm.RoomTypes()
                </select>
                <br />
                <label for="parkinput">Preferred park</label>
                <select id="parkinput" name="roompark" class="browser-default">
                    @RequestForm.Parks()
                </select>
                <br />
                <div onclick="loadRooms()" class="btn waves-effect">Update Room Suggestions</div>
                <br />
                <label for="roominput">Preferred room</label>
                <!-- <input list="roomlist" name="roompref" id="roominput" class="active"/> -->
                <select id="roomlist" class="browser-default" name="roompref">
                    @RequestForm.Rooms()
                </select>
                <br />
                <p>Required Facilities</p>
                <div class="row">
                    @RequestForm.RoomFacilities()
                </div>
                <br />
                <label for="specialinput">Special requirements</label>
                <textarea id="specialinput" name="special" class="materialize-textarea" length="200"></textarea>
                <input type="text" disabled name="owner" style="display:none;" value="@WebSecurity.CurrentUserId"/>

                
            </div>
        </div>
        <div class="row">
            <div class="col s12 l6">
                <input type="checkbox" id="addrooms" name="addrooms" />
                <label for="addrooms">Add additional rooms</label>
            </div>
            <div class="col s12 l6" id="form_buttons">
                <input class="btn waves-effect" type="submit" value="Submit" />
                <div onclick="window.location.reload()" class="btn waves-effect red">Clear</div>
            </div>
        </div>
    </form>
</div>
<div>
    @JsonList.PrintList("requestlist", JSON, "All requests")
</div>
<script>
    Materialize.updateTextFields();
</script>
@{
    DB.Close();
}
