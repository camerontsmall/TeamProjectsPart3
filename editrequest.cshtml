@using Models
@{
    Layout = "~/_Layout.cshtml";
    Page.Title = "Edit Request";
    Page.Path = "editrequest";
    Page.Parent = "Manage Requests";
    Page.ParentPath = "requests";
    var DB = Database.Open("dbConnectionString");
   
}
@if (Request.QueryString["delete"] != null) {
    //Delete request and all room requests
    string deleteId = Request.QueryString["delete"];

    string reqquery = "DELETE FROM request WHERE request_id=@0";
    string roomquery = "DELETE FROM request_room WHERE request_id=@0";

    try {
        DB.Execute(reqquery, deleteId);
        DB.Execute(roomquery, deleteId);

        Response.Redirect("~/requests?message=deleted&id=" + deleteId);
        Response.End();

    } catch (Exception e) {
        <div class="card-panel red">Error: @e.Message</div>
    }


}
@if (Request.QueryString["withdraw"] != null) {
    //Delete request and all room requests
    string wId = Request.QueryString["withdraw"];

    string wquery = "UPDATE request SET [status] = 'w' WHERE request_id = @0";

    try {
        DB.Execute(wquery, wId);

        Response.Redirect("~/requests?message=withdrawn&id=" + wId);
        Response.End();

    } catch (Exception e) {
        <div class="card-panel red">Error: @e.Message</div>
    }


}
@{ 
    var id = Request.QueryString["id"];
    if (id == null) {
        Response.Redirect("~/requests");
    }
}

@if (IsPost) {
    var module_code = Request.Form["modulecode"];
    var day = Request.Form["day"];
    var period = Request.Form["period"];
    var week = Request.Form["weeks"];

    var query = "UPDATE request SET status='p', module_code=@0, day=@1, period=@2, week=@3 WHERE request_id=@4";
    try {
        DB.Execute(query, module_code, day, period, week, id);
        <div class="card-panel green white-text">Saved changes</div>
    } catch (Exception e) {
        <div class="card-panel red">Failed to edit request: @e.Message</div>
    }
}

@{
    
    var data = DB.QuerySingle("SELECT * FROM request WHERE request_id=@0", id);

}



<h4>Edit Request @id</h4>
<div id="requestForm">
        <div class="row">
            <div class="col s12 m12 l6" id="form_left">
                <form method="post" action="./editrequest?id=@id">
                    <label for="titleinput">Module Code</label>
                    <select id="moduleinput" class="browser-default" name="modulecode">
                        @RequestForm.Modules(Department.User.departmentID(), data["module_code"])
                    </select>
                    <br />
                    <label for="dayinput">Day</label>
                    <select id="dayinput" class="browser-default" name="day">
                        @RequestForm.Days(data["day"])
                    </select>
                    <br />
                    <label for="periodinput">Period(s)</label>
                    <select multiple id="periodinput" class="browser-default" name="period">
                        @RequestForm.Periods(data["period"])
                    </select>
                    <br />
                    <label for="weeksinnput" class="active">Week(s)</label>
                    <select multiple id="weeksinput" class="browser-default" name="weeks">
                        @RequestForm.Weeks(data["week"])
                    </select>
                    <br />
                    <div class="col s12">
                        <input class="btn waves-effect" type="submit" value="Save" />
                        <div class="btn waves-effect red">Withdraw</div>
                    </div>
                </form>
            </div>
            <div class="col s12 m12 l6" id="form-right">
                @{ 
                    var room_data = DB.Query("SELECT * FROM request_room WHERE request_id = @0", Request.QueryString["id"]);

                    List<Dictionary<string, string>> items = new List<Dictionary<string, string>>();

                    foreach (dynamic r in room_data) {
                        items.Add(Models.RoomRequest.ToNiceList(r));
                    }

                    var JSON = Json.Encode(items);

                }
                @JsonList.PrintList("roomlist", JSON, "Room Requests")
            </div>
        </div>
</div>